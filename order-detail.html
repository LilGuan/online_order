<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>è¨‚å–®æ˜ç´° - é‚±åª½åª½ç¾é£Ÿ</title>
<!-- å¼•å…¥ Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<!-- å¼•å…¥ Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- å¼•å…¥ Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  body {
    font-family: 'Noto Sans TC', sans-serif;
    background-color: #f4f7f6;
    margin: 0;
    padding: 0;
    padding-bottom: 80px;
    color: #333;
  }

  /* æˆåŠŸç‹€æ…‹é ‚éƒ¨ */
  .success-header {
    background: #fff;
    padding: 30px 20px;
    text-align: center;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    margin-bottom: 20px;
  }
  .success-icon {
    font-size: 3rem;
    color: #28a745;
    margin-bottom: 10px;
  }
  .success-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d3436;
    margin-bottom: 5px;
  }
  .success-desc {
    color: #666;
    font-size: 0.9rem;
  }

  /* è³‡è¨Šå¡ç‰‡ */
  .container {
    padding: 0 20px;
    max-width: 600px;
    margin: 0 auto;
  }
  .info-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .card-title {
    font-size: 1rem;
    font-weight: 700;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 10px;
    margin-bottom: 15px;
    color: #444;
  }

  /* æ˜ç´°åˆ—è¡¨ */
  .order-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 0.95rem;
  }
  .item-name {
    color: #333;
    font-weight: 500;
    line-height: 1.4;
  }
  .item-qty {
    color: #888;
    font-size: 0.9rem;
    margin-left: 5px;
    white-space: nowrap;
  }
  .item-price {
    font-weight: 600;
    color: #333;
    margin-left: 10px;
  }

  /* ç¸½è¨ˆå€å¡Š */
  .total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px dashed #eee;
  }
  .total-label { font-size: 1rem; color: #555; }
  .total-amount { font-size: 1.3rem; font-weight: 700; color: #ff6b6b; }

  /* è¨‚å–®è³‡è¨Šåˆ—è¡¨ */
  .info-row {
    display: flex;
    margin-bottom: 10px;
    font-size: 0.95rem;
  }
  .info-label {
    width: 80px;
    color: #888;
    flex-shrink: 0;
  }
  .info-value {
    color: #333;
    font-weight: 500;
    word-break: break-all;
  }
  
  /* é‡è¦è³‡è¨Šçªé¡¯ */
  .highlight-box {
    background-color: #fff3cd;
    color: #856404;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
  }

  /* åº•éƒ¨æŒ‰éˆ• */
  .bottom-btn-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    padding: 15px 20px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    display: flex;
    justify-content: center;
  }
  .home-btn {
    background-color: #2d3436;
    color: white;
    border: none;
    padding: 12px 40px;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  .home-btn:hover { background-color: #444; color: white; }

  /* è¼‰å…¥/éŒ¯èª¤ç‹€æ…‹ */
  #loading, #error-msg {
    text-align: center;
    margin-top: 50px;
    color: #666;
  }
  #error-msg { display: none; }

</style>
</head>
<body>

<div id="loading">è¼‰å…¥ä¸­...</div>

<div id="error-msg">
  <i class="bi bi-exclamation-circle" style="font-size: 3rem; color: #dc3545;"></i>
  <p class="mt-2">æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™</p>
  <a href="index.html" class="btn btn-outline-secondary mt-3">è¿”å›é¦–é </a>
</div>

<div id="content" style="display: none;">
  
  <!-- æˆåŠŸç‹€æ…‹é ­éƒ¨ -->
  <div class="success-header">
    <i class="bi bi-check-circle-fill success-icon"></i>
    <div class="success-title">è¨‚è³¼æˆåŠŸï¼</div>
    <div class="success-desc">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼Œåº—å®¶å·²æ”¶åˆ°è¨‚å–®ã€‚</div>
  </div>

  <div class="container">
    
    <!-- å–é¤æç¤º -->
    <div class="highlight-box" id="pickup-highlight">
      <!-- ç´„ 12:30 å–é¤ -->
    </div>

    <!-- è¨‚å–®å…§å®¹ -->
    <div class="info-card">
      <div class="card-title">é¤é»æ˜ç´°</div>
      <div id="order-items">
        <!-- JS æ¸²æŸ“ -->
      </div>
      <div class="total-row">
        <span class="total-label">ç¸½è¨ˆ</span>
        <span class="total-amount" id="total-price">$0</span>
      </div>
    </div>

    <!-- è¨‚è³¼äººè³‡è¨Š -->
    <div class="info-card">
      <div class="card-title">è¨‚å–®è³‡è¨Š</div>
      <div class="info-row">
        <div class="info-label">è¨‚å–®ç·¨è™Ÿ</div>
        <div class="info-value" id="order-no"></div>
      </div>
      <div class="info-row">
        <div class="info-label">å§“å</div>
        <div class="info-value" id="order-name"></div>
      </div>
      <div class="info-row">
        <div class="info-label">é›»è©±</div>
        <div class="info-value" id="order-phone"></div>
      </div>
      <div class="info-row">
        <div class="info-label">ä»˜æ¬¾æ–¹å¼</div>
        <div class="info-value" id="payment-method"></div>
      </div>
      <div class="info-row">
        <div class="info-label">å‚™è¨»</div>
        <div class="info-value" id="order-notes"></div>
      </div>
    </div>

  </div>

  <div class="bottom-btn-container">
    <a href="index.html" class="home-btn">è¿”å›èœå–®</a>
  </div>

</div>

<!-- æˆåŠŸ Modal (è‡ªå‹•é¡¯ç¤º) -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content text-center">
      <div class="modal-body py-4">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
        <h5 class="mt-3">è¨‚è³¼æˆåŠŸ</h5>
        <p class="text-muted mb-0">æˆ‘å€‘æ­£åœ¨æº–å‚™æ‚¨çš„é¤é»</p>
      </div>
      <div class="modal-footer justify-content-center p-2">
        <button type="button" class="btn btn-sm btn-primary w-100" data-bs-dismiss="modal">ç¢ºå®š</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // é¤é»è³‡æ–™ (éœ€èˆ‡ index.html ä¸€è‡´)
  const menuItems = [
    { id: 1, name: 'è›‹ç‚’é£¯', price: 80 },
    { id: 2, name: 'è‚‰çµ²ç‚’é£¯', price: 100 },
    { id: 3, name: 'è‚‰çµ²ç‚’éºµ', price: 100 },
    { id: 4, name: 'é¦™è…¸ç‚’é£¯', price: 110 },
    { id: 5, name: 'è¦ä»ç‚’é£¯', price: 110 },
    { id: 6, name: 'è¦ä»ç‚’éºµ', price: 110 },
    { id: 7, name: 'è¦ä»ç±³è‹”ç›®', price: 110 },
    { id: 8, name: 'é¹¹è±¬è‚‰è“‹é£¯', price: 130 },
    { id: 9, name: 'é¹¹è±¬è‚‰', price: 230 },
    { id: 10, name: 'æµ·å¸¶èŠ½è›‹èŠ±æ¹¯', price: 25 },
    { id: 11, name: 'è·åŒ…è›‹', price: 15 },
  ];

  // è§£æ Key é‚è¼¯ (æ•´åˆé›™è›‹é¸é …)
  function parseCartItem(key) {
    const parts = key.split('-');
    const id = parseInt(parts[0]);
    const options = parts.slice(1);

    const item = menuItems.find(i => i.id === id);
    if (!item) return null;

    let finalPrice = item.price;
    let nameSuffix = [];

    if (options.includes('large')) {
      finalPrice += 20;
      nameSuffix.push('åŠ å¤§');
    }
    if (options.includes('egg')) {
      finalPrice += 15;
      nameSuffix.push('é›™è›‹');
    }
    if (options.includes('shrimp')) {
      finalPrice += 35;
      nameSuffix.push('åŠ è¦');
    }
    const displayName = item.name + (nameSuffix.length > 0 ? ` (${nameSuffix.join('ã€')})` : '');

    return {
      id,
      displayName,
      unitPrice: finalPrice
    };
  }

  // ====== Flex Message ç›¸é—œè¨­å®š (å¾ cart.html è¤‡è£½éä¾†) ======
  const BRAND_LOGO_URL = "https://raw.githubusercontent.com/LilGuan/online_order/main/images/logo.jpg";
  const BRAND_NAME = "é‚±åª½åª½ç¾é£Ÿ";
  const STORE_ADDRESS = "æ¡ƒåœ’å¸‚å¤§åœ’å€çš‡å®¶å…­è¡—12è™Ÿ";
  const HERO_IMAGE_URL = "https://images.unsplash.com/photo-1604908554007-0880a8a94571?q=80&w=1600&auto=format&fit=crop";
  const STORE_PHONE = "tel:033812828";
  const MAPS_URL = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(STORE_ADDRESS);
  const ORDER_DETAIL_URL = "https://liff.line.me/2007831775-ojeB1qbw/order-detail.html";
  const LIFF_ID = "2007831775-ojeB1qbw"; // æ‚¨çš„ LIFF ID

  function createOrderFlexMessage(orderData, menuItems) {
    const cart = orderData.cart;
    const items = [];
    let total = 0;

    for (const key in cart) {
        const qty = cart[key];
        const info = parseCartItem(key);
        if (!info) continue;
        const subtotal = info.unitPrice * qty;
        total += subtotal;
        items.push({
            type: "box", layout: "horizontal", margin: "sm",
            contents: [
                { type: "text", text: info.displayName, size: "sm", color: "#333333", flex: 5, wrap: true },
                { type: "text", text: `x${qty}`, size: "sm", color: "#666666", flex: 2, align: "center" },
                { type: "text", text: `$${subtotal}`, size: "sm", color: "#111111", flex: 3, align: "end" }
            ]
        });
    }

    // é€™è£¡ç‰¹åˆ¥æ¨™è¨»ã€Œå·²ä»˜æ¬¾ã€
    let paymentText = "ç¾é‡‘";
    if (orderData.paymentMethod === 'linepay_online') paymentText = "LINE Pay (å·²ä»˜æ¬¾)";
    else if (orderData.paymentMethod === 'online_payment') paymentText = "ç·šä¸Šä»˜æ¬¾ (å·²ä»˜æ¬¾)";

    const notesBox = orderData.notes ? {
        type: "box", layout: "vertical", backgroundColor: "#FFF8E1", cornerRadius: "8px", paddingAll: "10px", margin: "md",
        contents: [{ type: "text", text: "å‚™è¨»", weight: "bold", size: "sm", color: "#946200" }, { type: "text", text: orderData.notes, size: "sm", color: "#946200", wrap: true, margin: "xs" }]
    } : null;

    return {
        type: "flex", altText: `æ–°è¨‚å–® ${orderData.orderNumber} (å·²ä»˜æ¬¾)`,
        contents: {
            type: "bubble",
            header: {
                type: "box", layout: "vertical", paddingAll: "12px", backgroundColor: "#F6F8FF", spacing: "sm",
                contents: [
                    { type: "box", layout: "horizontal", contents: [{ type: "text", text: "âœ… è¨‚å–®å·²ä»˜æ¬¾ï¼Œåº—å®¶æº–å‚™ä¸­", weight: "bold", color: "#28a745", size: "sm" }] },
                    { type: "box", layout: "horizontal", spacing: "12px", contents: [{ type: "image", url: BRAND_LOGO_URL, size: "sm", aspectMode: "cover", aspectRatio: "1:1" }, { type: "box", layout: "vertical", contents: [{ type: "text", text: BRAND_NAME, weight: "bold", size: "md", color: "#1F1F1F" }, { type: "text", text: `#${orderData.orderNumber}`, size: "xs", color: "#8C8C8C" }] }] },
                    { type: "box", layout: "vertical", margin: "sm", contents: [{ type: "text", text: `å§“åï¼š${orderData.name}`, size: "sm", color: "#595959" }, { type: "text", text: `é›»è©±ï¼š${orderData.phone}`, size: "sm", color: "#595959", margin: "xs" }] },
                    { type: "box", layout: "horizontal", spacing: "sm", margin: "sm", contents: [{ type: "box", layout: "vertical", backgroundColor: "#E6FFFB", cornerRadius: "12px", paddingAll: "8px", flex: 7, contents: [{ type: "text", text: `â° ${orderData.pickupTime}`, size: "sm", color: "#08979C", wrap: false }] }, { type: "box", layout: "vertical", backgroundColor: "#FFF1F0", cornerRadius: "12px", paddingAll: "8px", flex: 5, contents: [{ type: "text", text: `ğŸ’³ ${paymentText}`, size: "sm", color: "#D4380D", wrap: false }] }] }
                ]
            },
            body: {
                type: "box", layout: "vertical", spacing: "sm", paddingTop: "0px",
                contents: [
                    { type: "box", layout: "horizontal", backgroundColor: "#FAFAFA", cornerRadius: "10px", paddingAll: "10px", contents: [{ type: "text", text: "ğŸ“", size: "sm", flex: 1 }, { type: "text", text: STORE_ADDRESS, size: "sm", color: "#434343", wrap: true, flex: 11 }] },
                    { type: "text", text: "å“é …", weight: "bold", size: "sm", color: "#262626", margin: "md" },
                    ...items,
                    { type: "box", layout: "horizontal", backgroundColor: "#F0F5FF", cornerRadius: "10px", paddingAll: "12px", margin: "md", contents: [{ type: "text", text: "ç¸½é‡‘é¡", weight: "bold", flex: 5, color: "#1D39C4" }, { type: "text", text: `$${total}`, weight: "bold", flex: 7, align: "end", color: "#1D39C4" }] },
                    ...(notesBox ? [notesBox] : [])
                ]
            },
            footer: {
                type: "box", layout: "horizontal", spacing: "sm",
                contents: [
                    { type: "box", layout: "vertical", flex: 4, backgroundColor: "#2F54EB", cornerRadius: "8px", paddingAll: "10px", action: { type: "uri", uri: ORDER_DETAIL_URL }, contents: [{ type: "text", text: "æŸ¥çœ‹è¨‚å–®", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }] },
                    { type: "box", layout: "vertical", flex: 4, backgroundColor: "#595959", cornerRadius: "8px", paddingAll: "10px", action: { type: "uri", uri: STORE_PHONE }, contents: [{ type: "text", text: "è¯çµ¡åº—å®¶", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }] },
                    { type: "box", layout: "vertical", flex: 4, backgroundColor: "#1890FF", cornerRadius: "8px", paddingAll: "10px", action: { type: "uri", uri: MAPS_URL }, contents: [{ type: "text", text: "åœ°åœ–å°èˆª", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }] }
                ]
            }
        }
    };
  }

  // æª¢æŸ¥æ˜¯å¦ç‚ºä»˜æ¬¾å¾Œè·³è½‰å›ä¾†
  async function checkPaymentStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const orderId = urlParams.get('orderId');

    console.log("URL Params:", status, orderId); // é™¤éŒ¯ç”¨

    if (status === 'success') {
      
      // 1. é¡¯ç¤ºæˆåŠŸ Modal
      const modal = new bootstrap.Modal(document.getElementById('successModal'));
      modal.show();

      // 2. è£œç™¼ LINE è¨Šæ¯
      const orderDataStr = localStorage.getItem('orderData');
      if (orderDataStr) {
        const orderData = JSON.parse(orderDataStr);
        
        // ç¢ºä¿è¨‚å–®ç·¨è™Ÿä¸€è‡´ (é¸ç”¨ï¼Œé¿å…è³‡æ–™éŒ¯äº‚)
        if (orderId && orderData.orderNumber !== orderId) {
             console.warn("URL orderId èˆ‡ localStorage ä¸ç¬¦ï¼Œä½†ä»å˜—è©¦ç™¼é€");
        }

        try {
            // åˆå§‹åŒ– LIFF
            await liff.init({ liffId: LIFF_ID });
            
            // æª¢æŸ¥æ˜¯å¦ç™»å…¥
            if (!liff.isLoggedIn()) {
                console.log("ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå˜—è©¦ç™»å…¥...");
                liff.login({ redirectUri: window.location.href }); // ç™»å…¥å¾Œè·³å›ç•¶å‰é é¢
                return; // ç™»å…¥æœƒé‡æ•´é é¢ï¼Œé€™è£¡å…ˆä¸­æ–·
            }

            if (liff.isInClient() || liff.isLoggedIn()) {
               console.log("æº–å‚™ç™¼é€ Flex Message...");
               const flex = createOrderFlexMessage(orderData, menuItems);
               
               await liff.sendMessages([flex]);
               console.log("Flex message å·²ç™¼é€ï¼");
            }
        } catch (err) {
            console.error('LIFF/SendMsg Error:', err);
            // alert('è¨Šæ¯è£œç™¼å¤±æ•—: ' + err.message); // é–‹ç™¼æ™‚å¯æ‰“é–‹
        }
      }
      
      // 3. æ¸…ç†å·¥ä½œ
      localStorage.removeItem('cart'); // æ¸…ç©ºè³¼ç‰©è»Š
      // æ¸…é™¤ URL åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†åˆè§¸ç™¼ (é€™è¡Œæœ€å¾ŒåŸ·è¡Œ)
      window.history.replaceState({}, document.title, window.location.pathname);
      
    } else {
       // ä¸€èˆ¬é€²å…¥ (éä»˜æ¬¾å›èª¿)ï¼Œå¦‚æœå·²çµå¸³éï¼Œæ¸…ç©ºè³¼ç‰©è»Š
       // (é€™è£¡çš„é‚è¼¯è¦–æ‚¨çš„éœ€æ±‚è€Œå®š)
    }
  }

  function renderOrder() {
    const orderDataStr = localStorage.getItem('orderData');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-msg');
    const contentEl = document.getElementById('content');

    loadingEl.style.display = 'none';

    if (!orderDataStr) {
      errorEl.style.display = 'block';
      return;
    }

    try {
      const orderData = JSON.parse(orderDataStr);
      const { cart, notes, paymentMethod, orderNumber, pickupTime, name, phone } = orderData;

      if (!cart || Object.keys(cart).length === 0) {
        errorEl.style.display = 'block';
        return;
      }

      contentEl.style.display = 'block';

      // å¡«å…¥è³‡è¨Š
      document.getElementById('order-no').textContent = `#${orderNumber}`;
      document.getElementById('pickup-highlight').textContent = `â° ${pickupTime}`;
      document.getElementById('order-name').textContent = name;
      document.getElementById('order-phone').textContent = phone;
      document.getElementById('payment-method').textContent = paymentMethod === 'cash' ? 'ç¾é‡‘ä»˜æ¬¾' : paymentMethod;
      document.getElementById('order-notes').textContent = notes || 'ç„¡';

      // æ¸²æŸ“æ˜ç´°åˆ—è¡¨
      const itemsContainer = document.getElementById('order-items');
      let total = 0;
      let itemsHtml = '';

      Object.keys(cart).forEach(key => {
        const qty = cart[key];
        
        // â˜…â˜…â˜… ä½¿ç”¨æ–°çš„è§£æé‚è¼¯ â˜…â˜…â˜…
        const info = parseCartItem(key);
        if (!info) return;

        const subtotal = info.unitPrice * qty;
        total += subtotal;

        itemsHtml += `
          <div class="order-item">
            <div style="flex: 1;">
              <span class="item-name">${info.displayName}</span>
            </div>
            <div>
              <span class="item-qty">x${qty}</span>
              <span class="item-price">$${subtotal}</span>
            </div>
          </div>
        `;
      });

      itemsContainer.innerHTML = itemsHtml;
      document.getElementById('total-price').textContent = `$${total}`;

      // â˜…â˜…â˜… ä¿®æ”¹é€™è£¡ â˜…â˜…â˜…
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('status') !== 'success') {
          // åªæœ‰åœ¨ã€Œéã€ä»˜æ¬¾è·³è½‰å›ä¾†çš„ä¸€èˆ¬æµç¨‹ï¼ˆç¾é‡‘ä»˜æ¬¾ï¼‰ï¼Œæ‰åœ¨é€™è£¡æ¸…ç©º
          localStorage.removeItem('cart');
          // é€™è£¡ä¹Ÿå¯ä»¥é¡¯ç¤ºæˆåŠŸ Modal
          const modal = new bootstrap.Modal(document.getElementById('successModal'));
          modal.show();
      }

    } catch (e) {
      console.error(e);
      errorEl.style.display = 'block';
    }
  }

  // é é¢è¼‰å…¥åŸ·è¡Œ
  renderOrder();
  checkPaymentStatus();
</script>

</body>
</html>