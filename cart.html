<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>è³¼ç‰©è»Š - é‚±åª½åª½ç¾é£Ÿ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- å¼•å…¥ Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<!-- å¼•å…¥ Bootstrap CSS (ç”¨æ–¼ Modal) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  /* CSS Reset & åŸºç¤è¨­å®š */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Noto Sans TC', sans-serif;
    background-color: #f4f7f6;
    margin: 0;
    padding: 0;
    padding-bottom: 100px; /* é ç•™åº•éƒ¨å›ºå®šæ¬„ç©ºé–“ */
    color: #333;
  }

  /* é ‚éƒ¨å°è¦½åˆ— */
  header {
    background-color: #fff;
    padding: 1rem;
    display: flex;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  #back-btn {
    font-size: 1.5rem;
    cursor: pointer;
    color: #333;
    padding: 0 10px;
    margin-right: 10px;
  }
  h2 {
    flex-grow: 1;
    text-align: center;
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: #333;
  }
  #clear-cart {
    font-size: 0.9rem;
    color: #ff6b6b;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
  }

  /* å®¹å™¨ */
  .container {
    padding: 1rem;
    max-width: 600px;
    margin: 0 auto;
  }

  /* è³¼ç‰©è»Šé …ç›®å¡ç‰‡ */
  .cart-item {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .item-info {
    flex-grow: 1;
    padding-right: 10px; /* é¿å…æ–‡å­—å¤ªé•·è²¼åˆ°æŒ‰éˆ• */
  }
  .item-name {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
    color: #2d3436;
    line-height: 1.4;
  }
  .item-price {
    color: #ff6b6b;
    font-weight: 600;
    font-size: 0.95rem;
  }

  /* æ•¸é‡æ§åˆ¶å€ */
  .qty-control {
    display: flex;
    align-items: center;
    background: #f1f3f5;
    border-radius: 20px;
    padding: 2px;
    margin: 0 10px;
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
  }
  .qty-control button {
    width: 28px;
    height: 28px;
    border: none;
    background: white;
    border-radius: 50%;
    font-size: 1rem;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .qty-control span {
    width: 30px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
  }

  /* åˆªé™¤æŒ‰éˆ• */
  .remove-btn {
    background: none;
    border: none;
    color: #adb5bd;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    flex-shrink: 0;
  }
  .remove-btn:hover { color: #ff6b6b; }

  /* è¡¨å–®å€å¡Š */
  .form-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  /* â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šè¡¨å–®æ¨™é¡Œåˆ—æ’ç‰ˆ â˜…â˜…â˜… */
  .form-header {
    display: flex;
    justify-content: space-between; /* æ¨™é¡Œé å·¦ï¼ŒæŒ‰éˆ•é å³ */
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .form-title {
    font-weight: 700;
    font-size: 1.1rem;
    padding-bottom: 10px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  .form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 0.9rem;
    color: #555;
  }
  .form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
    background-color: #f9f9f9;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #ff6b6b;
    background-color: #fff;
  }
  .mode-switch {
    display: flex;
    background: #f1f3f5;
    border-radius: 20px;
    padding: 2px;
    position: relative;
    width: 120px;
    cursor: pointer;
  }
  .mode-option {
    flex: 1;
    text-align: center;
    font-size: 0.8rem;
    line-height: 28px; /* å‚ç›´ç½®ä¸­ */
    z-index: 2;
    transition: color 0.3s;
    font-weight: 600;
    color: #666;
  }
  .mode-option.active {
    color: #fff;
  }
  .mode-bg {
    position: absolute;
    top: 2px;
    left: 2px;
    width: calc(50% - 2px);
    height: calc(100% - 4px);
    background: #ff6b6b;
    border-radius: 18px;
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 1;
  }
  /* é ç´„æ¨¡å¼æ™‚ï¼ŒèƒŒæ™¯æ»‘åˆ°å³é‚Š */
  .mode-switch.reserve .mode-bg {
    transform: translateX(100%);
  }
  /* åº•éƒ¨å›ºå®šçµå¸³å€ */
  .checkout-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    padding: 15px 20px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 100;
  }
  .total-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: #ff6b6b;
  }
  .total-label {
    font-size: 0.9rem;
    color: #666;
    margin-right: 5px;
  }
  #submit-order {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
  }
  #submit-order:active { transform: scale(0.98); background-color: #fa5252; }

  /* ç©ºè³¼ç‰©è»Šè¨Šæ¯ */
  #empty-msg {
    text-align: center;
    margin-top: 50px;
    color: #888;
    display: none;
  }
  #empty-msg i {
    font-size: 3rem;
    display: block;
    margin-bottom: 10px;
    color: #ddd;
  }

  /* éŒ¯èª¤æç¤ºæ¨£å¼ */
  .is-invalid { border-color: #dc3545 !important; }
  .error-text { color: #dc3545; font-size: 0.8rem; margin-top: 4px; display: none; }

</style>
</head>
<body>

<header>
  <div id="back-btn">âœ•</div>
  <h2>è³¼ç‰©è»Š</h2>
  <button id="clear-cart">æ¸…ç©º</button>
</header>

<div class="container">
  
  <div id="cart-items">
    <!-- è³¼ç‰©è»Šé …ç›®å°‡ç”± JS æ¸²æŸ“ -->
  </div>

  <div id="empty-msg">
    <i>ğŸ›’</i>
    è³¼ç‰©è»Šæ˜¯ç©ºçš„<br>å¿«å»é¸è³¼ç¾å‘³é¤é»å§ï¼
  </div>

  <div class="form-section">
    <!-- â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šä½¿ç”¨ form-header åŒ…è£¹æ¨™é¡Œèˆ‡åˆ‡æ›æŒ‰éˆ• â˜…â˜…â˜… -->
    <div class="form-header">
      <div class="form-title">è¨‚è³¼äººè³‡è¨Š</div>
      
      <!-- è¨‚é¤æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
      <div class="mode-switch" id="mode-switch">
        <div class="mode-bg"></div>
        <div class="mode-option active" id="mode-instant">å³æ™‚</div>
        <div class="mode-option" id="mode-reserve">é ç´„</div>
      </div>
    </div>
    
    <!-- ä»¥ä¸‹è¡¨å–®æ¬„ä½ä¿æŒä¸è®Š -->
    <div class="form-group">
      <label class="form-label" for="name">å§“å <span style="color:red">*</span></label>
      <input type="text" id="name" class="form-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
      <div class="error-text" id="name-error">è«‹è¼¸å…¥å§“å</div>
    </div>

    <div class="form-group">
      <label class="form-label" for="phone">é›»è©± <span style="color:red">*</span></label>
      <input type="tel" id="phone" class="form-input" placeholder="09xxxxxxxx" maxlength="10" />
      <div class="error-text" id="phone-error">è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±è™Ÿç¢¼</div>
    </div>

    <!-- é ç´„æ—¥æœŸ (æ‰“çƒŠå¾Œæ‰é¡¯ç¤º) -->
    <div class="form-group" id="date-group" style="display: none;">
      <label class="form-label" for="pickup-date">å–é¤æ—¥æœŸ <span style="color:red">*</span></label>
      <select id="pickup-date" class="form-select"></select>
    </div>

    <!-- å–é¤æ™‚é–“ (é ç´„æ¨¡å¼æ‰é¡¯ç¤º) -->
    <div class="form-group" id="time-group" style="display: none;">
      <label class="form-label" for="pickup-time">å–é¤æ™‚é–“ <span style="color:red">*</span></label>
      <select id="pickup-time" class="form-select">
        <option value="" disabled selected>è«‹é¸æ“‡å–é¤æ™‚é–“</option>
      </select>
      <div class="error-text" id="time-error">è«‹é¸æ“‡å–é¤æ™‚é–“</div>
    </div>

    <div class="form-group">
      <label class="form-label" for="payment-method">ä»˜æ¬¾æ–¹å¼</label>
      <select id="payment-method" class="form-select">
        <option value="cash" selected>ç¾é‡‘ä»˜æ¬¾</option>
        <option value="linepay_online">LINE Pay ç·šä¸Šä»˜æ¬¾</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" for="notes">å‚™è¨»</label>
      <textarea id="notes" class="form-textarea" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸è¦è¾£ã€å°‘æ²¹..."></textarea>
    </div>
  </div>

</div>

<!-- åº•éƒ¨å›ºå®šçµå¸³æ¬„ -->
<div class="checkout-bar">
  <div>
    <span class="total-label">ç¸½è¨ˆ</span>
    <span class="total-price" id="total-price">$0</span>
  </div>
  <button id="submit-order">é€å‡ºè¨‚å–®</button>
</div>

<!-- Modal ä¿æŒåŸæ¨£å¼•ç”¨ -->
<div class="modal fade" id="emptyCartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <p class="mb-0">è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼</p>
      </div>
      <div class="modal-footer justify-content-center p-2">
        <button type="button" class="btn btn-sm btn-secondary w-100" data-bs-dismiss="modal">ç¢ºå®š</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ====== ç‡Ÿæ¥­æ™‚é–“æª¢æŸ¥ ======
  function checkBusinessHours() {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    // 10:30-14:00 (630-840), 16:00-20:00 (960-1200)
    const isOpen = (currentTime >= 630 && currentTime < 840) || 
                   (currentTime >= 960 && currentTime < 1200);
    
    // return true; // æ¸¬è©¦æ™‚å¯é–‹å•Ÿ
    return isOpen;
  }

  // if (!checkBusinessHours()) {
  //   document.body.innerHTML = `
  //     <div style="
  //       position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  //       background: #f4f7f6; display: flex; flex-direction: column;
  //       align-items: center; justify-content: center; text-align: center;
  //       padding: 20px; color: #333;
  //     ">
  //       <h2 style="color:#ff6b6b;">ä¼‘æ¯ä¸­ ğŸ˜´</h2>
  //       <p>ç›®å‰éç‡Ÿæ¥­æ™‚é–“ï¼Œç„¡æ³•é€²è¡Œçµå¸³ã€‚</p>
  //       <p>ç‡Ÿæ¥­æ™‚é–“ï¼š10:30-14:00 / 16:00-20:00</p>
  //       <a href="index.html" style="
  //         margin-top: 20px; padding: 10px 20px;
  //         background: #333; color: white; border-radius: 20px;
  //         text-decoration: none;
  //       ">è¿”å›é¦–é </a>
  //     </div>
  //   `;
  // }

  const LIFF_ID = "2007831775-ojeB1qbw"; // ä½ çš„ LIFF ID

  // ====== Flex ç›¸é—œå¸¸æ•¸ ======
  const ORDER_DETAIL_URL = "https://liff.line.me/2007831775-ojeB1qbw/order-detail.html";
  const STORE_PHONE      = "tel:033812828";
  const BRAND_NAME       = "é‚±åª½åª½ç¾é£Ÿ";
  const BRAND_LOGO_URL   = "https://raw.githubusercontent.com/LilGuan/online_order/main/images/logo.jpg";
  const STORE_ADDRESS    = "æ¡ƒåœ’å¸‚å¤§åœ’å€çš‡å®¶å…­è¡—12è™Ÿ";
  const MAPS_URL         = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(STORE_ADDRESS);
  const HERO_IMAGE_URL   = "https://images.unsplash.com/photo-1604908554007-0880a8a94571?q=80&w=1600&auto=format&fit=crop";

  // ====== æ–°ç‰ˆèœå–®è³‡æ–™ (ä¸å«åŠ è¦ï¼Œå«é›™è›‹) ======
  const menuItems = [
    { id: 1, name: 'è›‹ç‚’é£¯', price: 80 },
    { id: 2, name: 'è‚‰çµ²ç‚’é£¯', price: 100 },
    { id: 3, name: 'è‚‰çµ²ç‚’éºµ', price: 100 },
    { id: 4, name: 'é¦™è…¸ç‚’é£¯', price: 110 },
    { id: 5, name: 'è¦ä»ç‚’é£¯', price: 110 },
    { id: 6, name: 'è¦ä»ç‚’éºµ', price: 110 },
    { id: 7, name: 'è¦ä»ç±³è‹”ç›®', price: 110 },
    { id: 8, name: 'é¹¹è±¬è‚‰è“‹é£¯', price: 130 },
    { id: 9, name: 'é¹¹è±¬è‚‰', price: 230 },
    { id: 10, name: 'æµ·å¸¶èŠ½è›‹èŠ±æ¹¯', price: 25 },
    { id: 11, name: 'è·åŒ…è›‹', price: 15 },
  ];

  // å…ƒç´ é¸å–
  const cartContainer = document.getElementById('cart-items');
  const totalPriceEl = document.getElementById('total-price');
  const emptyMsg = document.getElementById('empty-msg');
  const submitBtn = document.getElementById('submit-order');
  const emptyCartModal = new bootstrap.Modal(document.getElementById('emptyCartModal'));
  const pickupTimeSelect = document.getElementById('pickup-time');
  const pickupDateSelect = document.getElementById('pickup-date');
  const timeGroup = document.getElementById('time-group');
  const dateGroup = document.getElementById('date-group');
  const modeSwitch = document.getElementById('mode-switch');
  const modeInstant = document.getElementById('mode-instant');
  const modeReserve = document.getElementById('mode-reserve');

  // ç‹€æ…‹è®Šæ•¸
  let currentMode = 'instant'; // 'instant' æˆ– 'reserve'
  let isBusinessHours = false;
  let isClosedForToday = false; // æ˜¯å¦å·²éä»Šæ—¥ç‡Ÿæ¥­æ™‚é–“ (æ‰“çƒŠ)

  // è¼‰å…¥è³¼ç‰©è»Šè³‡æ–™
  function loadCart() {
    return JSON.parse(localStorage.getItem('cart') || '{}');
  }

  function saveCart(cart) {
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart(); // å„²å­˜å¾Œé‡æ–°æ¸²æŸ“
  }

  // â˜…â˜…â˜… æ–°å¢ï¼šè§£æ Key çš„å‡½å¼ (æ•´åˆé›™è›‹åƒ¹æ ¼) â˜…â˜…â˜…
  function parseCartItem(key) {
    // Key æ ¼å¼: ID-option1-option2... (ä¾‹å¦‚: 1-large-egg)
    const parts = key.split('-');
    const id = parseInt(parts[0]);
    const options = parts.slice(1);

    const item = menuItems.find(i => i.id === id);
    if (!item) return null;

    let finalPrice = item.price;
    let nameSuffix = [];

    if (options.includes('large')) {
      finalPrice += 20;
      nameSuffix.push('åŠ å¤§');
    }
    if (options.includes('egg')) {
      finalPrice += 15;
      nameSuffix.push('é›™è›‹');
    }
    if (options.includes('shrimp')) {
      finalPrice += 35;
      nameSuffix.push('åŠ è¦');
    }

    const displayName = item.name + (nameSuffix.length > 0 ? ` (${nameSuffix.join('ã€')})` : '');

    return {
      id,
      displayName,
      unitPrice: finalPrice
    };
  }

  // æ¸²æŸ“è³¼ç‰©è»Šåˆ—è¡¨ (ä½¿ç”¨ parseCartItem)
  function renderCart() {
    const cart = loadCart();
    const keys = Object.keys(cart);
    
    // æ¸…ç©ºå®¹å™¨
    cartContainer.innerHTML = '';
    
    if (keys.length === 0) {
      emptyMsg.style.display = 'block';
      totalPriceEl.innerText = '$0';
      // ç¦ç”¨é€å‡ºæŒ‰éˆ•
      submitBtn.style.opacity = '0.5';
      submitBtn.style.pointerEvents = 'none';
      return;
    }

    emptyMsg.style.display = 'none';
    submitBtn.style.opacity = '1';
    submitBtn.style.pointerEvents = 'auto';

    let total = 0;

    keys.forEach(key => {
      const qty = cart[key];
      // â˜…â˜…â˜… å‘¼å«è§£æå‡½å¼ â˜…â˜…â˜…
      const info = parseCartItem(key);
      if (!info) return; // é˜²å‘†

      const subtotal = info.unitPrice * qty;
      total += subtotal;

      // å»ºç«‹å¡ç‰‡å…ƒç´ 
      const itemEl = document.createElement('div');
      itemEl.className = 'cart-item';
      itemEl.innerHTML = `
        <div class="item-info">
          <div class="item-name">${info.displayName}</div>
          <div class="item-price">$${info.unitPrice}</div>
        </div>
        <div class="qty-control">
          <button onclick="changeQty('${key}', -1)">âˆ’</button>
          <span>${qty}</span>
          <button onclick="changeQty('${key}', 1)">+</button>
        </div>
        <button class="remove-btn" onclick="removeItem('${key}')">ğŸ—‘ï¸</button>
      `;
      cartContainer.appendChild(itemEl);
    });

    totalPriceEl.innerText = `$${total}`;
  }

  // ä¿®æ”¹æ•¸é‡
  window.changeQty = function(key, delta) {
    const cart = loadCart();
    const current = cart[key] || 1;
    const newQty = current + delta;

    if (newQty <= 0) {
      // è‹¥æ•¸é‡è®Šç‚º 0ï¼Œç›´æ¥åˆªé™¤ (ä¸è·³ alert)
      delete cart[key];
    } else {
      cart[key] = newQty;
    }
    saveCart(cart);
  };

  // ç§»é™¤é …ç›® (ä¸è·³ alert)
  window.removeItem = function(key) {
    const cart = loadCart();
    delete cart[key];
    saveCart(cart);
  };

  // æ¸…ç©ºè³¼ç‰©è»Š
  document.getElementById('clear-cart').addEventListener('click', () => {
    if (confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
      localStorage.removeItem('cart');
      renderCart();
    }
  });

  // è¿”å›æŒ‰éˆ•
  document.getElementById('back-btn').addEventListener('click', () => {
    window.location.href = 'index.html';
  });
  
  // åˆå§‹åŒ– LIFF (åŒ…å«è‡ªå‹•å¡«å…¥é›»è©±)
  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        
        // 1. è‡ªå‹•å¡«å…¥å§“å
        const nameInput = document.getElementById('name');
        if (!nameInput.value) {
          nameInput.value = profile.displayName; 
        }

        // 2. â˜…â˜…â˜… è‡ªå‹•å¡«å…¥ä¸Šæ¬¡ä½¿ç”¨çš„é›»è©± â˜…â˜…â˜…
        const savedPhone = localStorage.getItem('userPhone'); // å¾ç€è¦½å™¨è¨˜æ†¶è®€å–
        const phoneInput = document.getElementById('phone');
        if (savedPhone && !phoneInput.value) {
          phoneInput.value = savedPhone;
        }
      }
    } catch (err) {
      console.error(err);
    }
  }
  // ====== æ™‚æ®µé‚è¼¯è™•ç† ======

  function initMode() {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    // ç‡Ÿæ¥­æ™‚é–“åˆ¤æ–·
    // åˆé¤: 10:30 (630) - 14:00 (840)
    // æ™šé¤: 16:00 (960) - 20:00 (1200)
    isBusinessHours = (currentMinutes >= 630 && currentMinutes < 840) || (currentMinutes >= 960 && currentMinutes < 1200);
    
    // åˆ¤æ–·æ˜¯å¦å·²æ‰“çƒŠ (è¶…é 20:00)
    isClosedForToday = currentMinutes >= 1200;

    if (!isBusinessHours) {
      // éç‡Ÿæ¥­æ™‚é–“ï¼Œå¼·åˆ¶åˆ‡æ›åˆ°é ç´„æ¨¡å¼ä¸¦é–å®š
      setMode('reserve');
      modeSwitch.style.pointerEvents = 'none'; // ç¦ç”¨åˆ‡æ›
      modeSwitch.style.opacity = '0.7'; // ç¨å¾®è®Šæ·¡æç¤ºä¸å¯ç”¨
      
      // å¦‚æœå·²æ‰“çƒŠï¼Œé¡¯ç¤ºæ—¥æœŸé¸æ“‡
      if (isClosedForToday) {
        initDateSelect();
      }
    } else {
      // ç‡Ÿæ¥­æ™‚é–“å…§ï¼Œé è¨­å³æ™‚ï¼Œå¯åˆ‡æ›
      setMode('instant');
      modeSwitch.style.pointerEvents = 'auto';
      modeSwitch.style.opacity = '1';
    }

    // åˆå§‹åŒ–æ™‚é–“é¸å–® (æ ¹æ“šé è¨­æ¨¡å¼)
    updateTimeSlots();
  }

  function setMode(mode) {
    currentMode = mode;
    if (mode === 'instant') {
      modeSwitch.classList.remove('reserve');
      modeInstant.classList.add('active');
      modeReserve.classList.remove('active');
      timeGroup.style.display = 'none';
      dateGroup.style.display = 'none';
    } else {
      modeSwitch.classList.add('reserve');
      modeInstant.classList.remove('active');
      modeReserve.classList.add('active');
      timeGroup.style.display = 'block';
      if (isClosedForToday) {
         dateGroup.style.display = 'block';
      }
    }
    updateTimeSlots();
  }

  // é»æ“Šåˆ‡æ›æ¨¡å¼
  modeSwitch.addEventListener('click', () => {
    // å¦‚æœè¢«é–å®š (éç‡Ÿæ¥­æ™‚é–“)ï¼Œä¸åŸ·è¡Œåˆ‡æ›
    if (modeSwitch.style.pointerEvents === 'none') return;
    
    if (currentMode === 'instant') setMode('reserve');
    else setMode('instant');
  });

  // åˆå§‹åŒ–æ—¥æœŸé¸å–® (æœªä¾†ä¸‰å¤©)
  function initDateSelect() {
    pickupDateSelect.innerHTML = '';
    const today = new Date();
    
    for (let i = 1; i <= 3; i++) { // å¾æ˜å¤©é–‹å§‹ç®— 3 å¤©
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      
      const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
      const displayStr = `${d.getMonth() + 1}/${d.getDate()} (é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
      
      const option = document.createElement('option');
      option.value = dateStr;
      option.text = displayStr;
      pickupDateSelect.appendChild(option);
    }
  }

  function updateTimeSlots() {
    if (currentMode === 'instant') return; // å³æ™‚æ¨¡å¼ä¸éœ€è¦ç”¢ç”Ÿé¸å–®

    pickupTimeSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å–é¤æ™‚é–“</option>';
    const slots = [];
    
    function addSlots(start, end) {
      for (let time = start; time <= end; time += 30) {
        slots.push(time);
      }
    }
    // ç‡Ÿæ¥­æ™‚é–“ (å¯ä¾éœ€æ±‚èª¿æ•´ç¯„åœ)
    addSlots(645, 825);  // 10:45 - 13:45
    addSlots(975, 1185); // 16:15 - 19:45

    const now = new Date();
    // å–å¾—ç•¶å‰æ™‚é–“çš„åˆ†é˜æ•¸
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    // â˜…â˜…â˜… è¨­å®šç·©è¡æ™‚é–“ (15åˆ†é˜) â˜…â˜…â˜…
    // åªæœ‰ç•¶é ç´„æ™‚é–“ > (ç¾åœ¨æ™‚é–“ + 15åˆ†é˜) æ‰æ˜¯æœ‰æ•ˆé ç´„
    const bufferMinutes = 15;
    const minValidTime = currentMinutes + bufferMinutes;

    // å¦‚æœæ˜¯æ‰“çƒŠå¾Œé ç´„ (é¸æ“‡äº†æœªä¾†æ—¥æœŸ)ï¼Œå‰‡æ‰€æœ‰æ™‚æ®µéƒ½é–‹æ”¾
    const isFutureDate = isClosedForToday; 

    slots.forEach(time => {
        const h = Math.floor(time / 60).toString().padStart(2, '0');
        const m = (time % 60).toString().padStart(2, '0');
        const timeStr = `${h}:${m}`;
        
        const option = document.createElement('option');
        option.value = timeStr;
        option.text = timeStr;
        
        // é‚è¼¯åˆ¤æ–·ï¼š
        if (!isFutureDate) {
            // å¦‚æœæ˜¯ã€Œä»Šå¤©ã€ï¼Œéœ€è¦æª¢æŸ¥æ™‚é–“
            if (time < minValidTime) {
                // â˜…â˜…â˜… ä¿®æ”¹ï¼šå¦‚æœæ™‚é–“æ—©æ–¼ (ç¾åœ¨+15åˆ†)ï¼Œç›´æ¥ä¸åŠ å…¥é¸å–® (éš±è—) â˜…â˜…â˜…
                // å¦‚æœä½ æƒ³å®Œå…¨ä¸é¡¯ç¤ºï¼Œå°±ç›´æ¥ return; (åœ¨ forEach ä¸­æ˜¯ returnï¼Œç›¸ç•¶æ–¼ continue)
                return; 
                
                // å¦‚æœä½ æƒ³é¡¯ç¤ºä½† disableï¼Œä¿ç•™ä¸‹é¢é€™å…©è¡Œï¼Œä¸¦æ‹¿æ‰ä¸Šé¢çš„ return
                // option.text = `${timeStr} (å·²é)`;
                // option.disabled = true;
            }
        }
        
        // åŠ å…¥æœ‰æ•ˆé¸é …
        pickupTimeSelect.appendChild(option);
    });
  }
  // é é¢è¼‰å…¥åŸ·è¡Œ
  renderCart();
  initLiff();
  initMode(); 

  // ====== è¡¨å–®é©—è­‰èˆ‡é€å‡º ======
  submitBtn.addEventListener('click', () => {
    const cart = loadCart();
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const timeInput = document.getElementById('pickup-time');
    const dateInput = document.getElementById('pickup-date');
    
    const nameError = document.getElementById('name-error');
    const phoneError = document.getElementById('phone-error');
    const timeError = document.getElementById('time-error');
    
    let isValid = true;
    nameInput.classList.remove('is-invalid');
    phoneInput.classList.remove('is-invalid');
    timeInput.classList.remove('is-invalid');
    nameError.style.display = 'none';
    phoneError.style.display = 'none';
    timeError.style.display = 'none';

    if (Object.keys(cart).length === 0) { emptyCartModal.show(); return; }

    let name = nameInput.value.trim();
    if (!name) { nameInput.classList.add('is-invalid'); nameError.style.display = 'block'; isValid = false; }

    const phone = phoneInput.value.trim();
    const taiwanPhoneRegex = /^09\d{8}$|^0\d{1,2}-?\d{6,8}$/;
    if (!phone || !taiwanPhoneRegex.test(phone)) { phoneInput.classList.add('is-invalid'); phoneError.style.display = 'block'; isValid = false; }

    // é©—è­‰æ™‚é–“èˆ‡è³¦å€¼
    let finalPickupTime = "";
    
    if (currentMode === 'reserve') {
        // é ç´„æ¨¡å¼ï¼šå¿…é ˆé¸æ™‚é–“
        const timeVal = timeInput.value;
        if (!timeVal) {
            timeInput.classList.add('is-invalid');
            timeError.style.display = 'block';
            isValid = false;
        } else {
            // å¦‚æœæœ‰æ—¥æœŸ (æ‰“çƒŠå¾Œ)ï¼Œçµ„åˆæ—¥æœŸ+æ™‚é–“
            if (isClosedForToday) {
                 const dateVal = dateInput.options[dateInput.selectedIndex].text; // æ‹¿é¡¯ç¤ºæ–‡å­— (1/20 é€±ä¸€)
                 finalPickupTime = `${dateVal} ${timeVal}`;
            } else {
                 finalPickupTime = timeVal; // åƒ…æ™‚é–“
            }
        }
    } else {
        // â˜…â˜…â˜… ä¿®æ­£é€™è£¡ï¼šå³æ™‚æ¨¡å¼ä¹Ÿè¦è¨­å®š finalPickupTime â˜…â˜…â˜…
        // è‡ªå‹•è¨ˆç®— ç¾åœ¨ + 15 åˆ†
        const now = new Date();
        now.setMinutes(now.getMinutes() + 15);
        finalPickupTime = `ç´„ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} å–é¤`;
    }

    if (!isValid) return; // é©—è­‰æœªé€šéå‰‡åœæ­¢

    if (name.length <= 5) name += ' å…ˆç”Ÿ/å°å§';

    const orderNumber = (() => {
        const chars = 'ABCDEF0123456789';
        let r = ''; for(let i=0; i<6; i++) r += chars.charAt(Math.floor(Math.random()*chars.length));
        return r;
    })();

    const notes = document.getElementById('notes').value.trim();
    // å–å¾—ä»˜æ¬¾æ–¹å¼
    const paymentMethod = document.getElementById('payment-method').value;

    const orderData = { name, phone, cart, notes, paymentMethod, orderNumber, pickupTime: finalPickupTime };
    localStorage.setItem('orderData', JSON.stringify(orderData));
    localStorage.setItem('userPhone', phone); 


    // â˜…â˜…â˜… LINE Pay ä¸²æ¥é‚è¼¯ â˜…â˜…â˜…
    if (paymentMethod === 'linepay_online') {
        
        // æº–å‚™å‚³çµ¦å¾Œç«¯çš„å•†å“è³‡æ–™
        let itemsForLinePay = [];
        for (const key in cart) {
             const qty = cart[key];
             const info = parseCartItem(key);
             if (info) {
                 itemsForLinePay.push({
                     name: info.displayName,
                     qty: qty,
                     price: info.unitPrice
                 });
             }
        }

        // å–å¾—ç›®å‰ç¸½é‡‘é¡
        let totalAmount = 0;
        itemsForLinePay.forEach(i => totalAmount += (i.price * i.qty));

        // æ‚¨çš„ ngrok ç¶²å€
        const backendUrl = 'https://35e4107acd64.ngrok-free.app/api/linepay/request';

        // å‘¼å«å¾Œç«¯å»ºç«‹ LINE Pay è¨‚å–®
        fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                totalAmount: totalAmount,
                items: itemsForLinePay,
                orderNumber: orderNumber
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.paymentUrl) {
                // è·³è½‰åˆ° LINE Pay ä»˜æ¬¾é é¢
                window.location.href = data.paymentUrl;
            } else {
                alert('LINE Pay èµ·å§‹å¤±æ•—');
            }
        })
        .catch(err => {
            console.error(err);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        });

        return; // æš«åœå¾ŒçºŒå‹•ä½œï¼Œç­‰å¾…è·³è½‰
    }
    // â˜…â˜…â˜… çµæŸ â˜…â˜…â˜…

    // â˜…â˜…â˜…â˜…â˜…â˜… æ–°å¢ï¼šç¶ ç•Œé‡‘æµä¸²æ¥é‚è¼¯ â˜…â˜…â˜…â˜…â˜…â˜…
    if (paymentMethod === 'online_payment') { 
        // è¨ˆç®—ç¸½é‡‘é¡
        let totalAmount = 0;
        let itemNames = [];
        
        for (const key in cart) {
            const qty = cart[key];
            const info = parseCartItem(key);
            if (info) {
                totalAmount += info.unitPrice * qty;
                itemNames.push(`${info.displayName} x ${qty}`);
            }
        }

        // æ‚¨çš„ ngrok ç¶²å€ (è«‹æ›æˆæ‚¨å¯¦éš›é‹ä½œä¸­çš„ç¶²å€)
        const backendUrl = 'https://35e4107acd64.ngrok-free.app/api/createOrder'; 

        // å‘¼å«å¾Œç«¯ API
        fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                totalAmount: totalAmount, 
                items: itemNames,
                tradeDesc: 'é‚±åª½åª½ç¾é£Ÿç·šä¸Šè¨‚è³¼'
            })
        })
        .then(response => response.text())
        .then(html => {
            // å°‡å¾Œç«¯å›å‚³çš„ HTML è¡¨å–®å¯«å…¥é é¢ä¸¦è‡ªå‹•é€å‡ºï¼Œè·³è½‰è‡³ç¶ ç•Œ
            document.open();
            document.write(html);
            document.close();
        })
        .catch(error => {
            console.error('ä»˜æ¬¾å¤±æ•—:', error);
            alert('ç„¡æ³•é€£æ¥ä»˜æ¬¾ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        });
        
        return; // é˜»æ­¢å¾ŒçºŒåŸ·è¡Œ (ä¸é€å‡º LINE è¨Šæ¯ï¼Œå› ç‚ºè¦å…ˆä»˜æ¬¾)
    }
    // â˜…â˜…â˜…â˜…â˜…â˜… ç¶ ç•Œé‡‘æµä¸²æ¥é‚è¼¯çµæŸ â˜…â˜…â˜…â˜…â˜…â˜…

    const flexMessage = createOrderFlexMessage(orderData, menuItems);
    sendOrderMessage(flexMessage);
  });

  function generateOrderNumber() {
    const chars = 'ABCDEF0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
    return result;
  }

  function getPickupTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 15);
    return `ç´„ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} å–é¤`;
  }

  // Flex Message ç”¢ç”Ÿå‡½å¼ (æ’ç‰ˆå·²å„ªåŒ– & æ”¯æ´æ–°é‚è¼¯)
  function createOrderFlexMessage(orderData, menuItems) {
    const cart = orderData.cart;
    const items = [];
    let total = 0;

    for (const key in cart) {
      const qty = cart[key];
      
      // â˜…â˜…â˜… åœ¨æ­¤è™•ç›´æ¥å¯¦ä½œè§£æé‚è¼¯ï¼Œç”¢ç”Ÿå¡ç‰‡å…§å®¹ â˜…â˜…â˜…
      const parts = key.split('-');
      const id = parseInt(parts[0]);
      const options = parts.slice(1);
      
      const item = menuItems.find(i => i.id === id);
      if (!item) continue;

      let price = item.price;
      let nameSuffix = [];

      if (options.includes('large')) { price += 20; nameSuffix.push('åŠ å¤§'); }
      if (options.includes('egg')) { price += 15; nameSuffix.push('é›™è›‹'); }
      if (options.includes('shrimp')) { price += 35; nameSuffix.push('åŠ è¦'); }
      

      const name = item.name + (nameSuffix.length > 0 ? ` (${nameSuffix.join('ã€')})` : '');
      const subtotal = price * qty;
      total += subtotal;

      items.push({
        type: "box",
        layout: "horizontal",
        contents: [
          { type: "text", text: name, size: "sm", color: "#333333", flex: 5, wrap: true },
          { type: "text", text: `x${qty}`, size: "sm", color: "#666666", flex: 2, align: "center" },
          { type: "text", text: `$${subtotal}`, size: "sm", color: "#111111", flex: 3, align: "end" }
        ],
        margin: "sm"
      });
    }

    const paymentText = orderData.paymentMethod === "cash" ? "ç¾é‡‘" : orderData.paymentMethod;
    const pickupSingleLine = `â° ${orderData.pickupTime}`;

    const notesBox = orderData.notes ? {
      type: "box",
      layout: "vertical",
      backgroundColor: "#FFF8E1",
      cornerRadius: "8px",
      paddingAll: "10px",
      contents: [
        { type: "text", text: "å‚™è¨»", weight: "bold", size: "sm", color: "#946200" },
        { type: "text", text: orderData.notes, size: "sm", color: "#946200", wrap: true, margin: "xs" }
      ],
      margin: "md"
    } : null;

    return {
      type: "flex",
      altText: `æ–°è¨‚å–® ${orderData.orderNumber} (å¾…ç¢ºèª)`,
      contents: {
        type: "bubble",
        header: {
          type: "box",
          layout: "vertical",
          paddingAll: "12px",
          backgroundColor: "#F6F8FF", 
          spacing: "sm",
          contents: [
            // â˜…â˜…â˜… ç‹€æ…‹æç¤º â˜…â˜…â˜…
            {
              type: "box",
              layout: "horizontal",
              contents: [
                { type: "text", text: "â³ è¨‚å–®å·²é€å‡ºï¼Œç­‰å¾…åº—å®¶ç¢ºèª", weight: "bold", color: "#E6A23C", size: "sm" }
              ]
            },
            {
              type: "box",
              layout: "horizontal",
              spacing: "12px",
              contents: [
                { type: "image", url: BRAND_LOGO_URL, size: "sm", aspectMode: "cover", aspectRatio: "1:1" },
                {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    { type: "text", text: BRAND_NAME, weight: "bold", size: "md", color: "#1F1F1F" },
                    { type: "text", text: `#${orderData.orderNumber}`, size: "xs", color: "#8C8C8C" }
                  ]
                }
              ]
            },
            {
              type: "box",
              layout: "vertical",
              margin: "sm",
              contents: [
                { type: "text", text: `å§“åï¼š${orderData.name}`, size: "sm", color: "#595959" },
                { type: "text", text: `é›»è©±ï¼š${orderData.phone}`, size: "sm", color: "#595959", margin: "xs" }
              ]
            },
            {
              type: "box",
              layout: "horizontal",
              spacing: "sm",
              margin: "sm",
              contents: [
                {
                  type: "box",
                  layout: "vertical",
                  backgroundColor: "#E6FFFB",
                  cornerRadius: "12px",
                  paddingAll: "8px",
                  contents: [
                    { type: "text", text: pickupSingleLine, size: "sm", color: "#08979C", wrap: false }
                  ],
                  flex: 7
                },
                {
                  type: "box",
                  layout: "vertical",
                  backgroundColor: "#FFF1F0",
                  cornerRadius: "12px",
                  paddingAll: "8px",
                  contents: [
                    { type: "text", text: `ğŸ’³ ${paymentText}`, size: "sm", color: "#D4380D", wrap: false }
                  ],
                  flex: 5
                }
              ]
            }
          ]
        },
        body: {
          type: "box",
          layout: "vertical",
          spacing: "sm",
          paddingTop: "0px", // â˜…â˜…â˜… ç§»é™¤ç•™ç™½ â˜…â˜…â˜…
          contents: [
            {
              type: "box",
              layout: "horizontal",
              backgroundColor: "#FAFAFA",
              cornerRadius: "10px",
              paddingAll: "10px",
              contents: [
                { type: "text", text: "ğŸ“", size: "sm", flex: 1 },
                { type: "text", text: STORE_ADDRESS, size: "sm", color: "#434343", wrap: true, flex: 11 }
              ]
            },
            { type: "text", text: "å“é …", weight: "bold", size: "sm", color: "#262626", margin: "md" },
            ...items,
            {
              type: "box",
              layout: "horizontal",
              backgroundColor: "#F0F5FF",
              cornerRadius: "10px",
              paddingAll: "12px",
              margin: "md",
              contents: [
                { type: "text", text: "ç¸½é‡‘é¡", weight: "bold", flex: 5, color: "#1D39C4" },
                { type: "text", text: `$${total}`, weight: "bold", flex: 7, align: "end", color: "#1D39C4" }
              ]
            },
            ...(notesBox ? [notesBox] : []),
            {
                type: "text",
                text: "*è«‹ç•™æ„åº—å®¶å›è¦†ç¢ºèªè¨Šæ¯ï¼Œä»¥ç¢ºä¿è¨‚å–®æˆç«‹ã€‚",
                size: "xxs",
                color: "#999999",
                wrap: true,
                margin: "lg",
                align: "center"
            }
          ]
        },
        footer: {
          type: "box",
          layout: "horizontal",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "vertical",
              flex: 4,
              backgroundColor: "#2F54EB",
              cornerRadius: "8px",
              paddingAll: "10px",
              action: { type: "uri", uri: ORDER_DETAIL_URL },
              contents: [
                { type: "text", text: "æŸ¥çœ‹è¨‚å–®", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }
              ]
            },
            {
              type: "box",
              layout: "vertical",
              flex: 4,
              backgroundColor: "#595959",
              cornerRadius: "8px",
              paddingAll: "10px",
              action: { type: "uri", uri: STORE_PHONE },
              contents: [
                { type: "text", text: "è¯çµ¡åº—å®¶", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }
              ]
            },
            {
              type: "box",
              layout: "vertical",
              flex: 4,
              backgroundColor: "#1890FF",
              cornerRadius: "8px",
              paddingAll: "10px",
              action: { type: "uri", uri: MAPS_URL },
              contents: [
                { type: "text", text: "åœ°åœ–å°èˆª", size: "xs", weight: "bold", align: "center", color: "#FFFFFF", wrap: false }
              ]
            }
          ]
        },
        styles: { body: { separator: false }, footer: { separator: false } }
      }
    };
  }

  function sendOrderMessage(flexMessage) {
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    liff.sendMessages([flexMessage])
      .then(() => {
        window.location.href = 'order-detail.html';
      })
      .catch((err) => {
        console.error('Error sending message:', err);
        alert('è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦ä½¿ç”¨æ‰‹æ©Ÿç‰ˆLineå®˜æ–¹è¨‚è³¼ã€‚');
      });
  }

</script>
</body>
</html>